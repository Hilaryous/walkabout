<div id="directions" style='width: 100%; height: 75vh;'></div>
<%= javascript_include_tag('map_style.js') %>
<script>
  $(document).ready(function initialize(){
    var directionsService = new google.maps.DirectionsService();
    var directionsDisplay = new google.maps.DirectionsRenderer();
    var waypoints = <%= @walk.waypoints.html_safe %>;
    var wypnts = [];

    for (var i = 0; i < waypoints.length; i++) {
      wypnts.push({
          location: new google.maps.LatLng(waypoints[i].latitude, waypoints[i].longitude),
          stopover: true
      });
    }

    function calcRoute(){
      var origin = new google.maps.LatLng(<%= @walk.start_location.latitude %>,<%= @walk.start_location.longitude %>);
      var destination = new google.maps.LatLng(<%= @walk.start_location.latitude %>, <%= @walk.start_location.longitude %>);

      var request = {
        origin: origin,
        destination:destination,
        waypoints: wypnts,
        optimizeWaypoints: true,
        travelMode: google.maps.DirectionsTravelMode.WALKING,
        unitSystem: google.maps.UnitSystem.IMPERIAL
      };

      directionsService.route(request ,function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          var distance = document.getElementById('distance');
          distance.innerHTML = (response.routes[0].legs[0].distance.text) + distance.innerHTML;

          var legsLength = response.routes[0].legs.length;
          console.log(response.routes[0].legs);
          for (var i = 0; i < legsLength; i++) {
            var legs = document.getElementById("legs");
            var collapse_name = "#collapse-" + (i + 2)
            var new_collapse_name ='collapse-' + (i + 2)
            var step_id = 'step-' + (i+ 2)
            var leg_address = response.routes[0].legs[i].end_address;
            var not_last_leg = legsLength - 1
            if(i < not_last_leg)
              legs.innerHTML +=
              '<div class="panel-heading">' +
                '<h4 class="panel-title">' +
                  '<a data-toggle="collapse" data-parent="#accordion" href="' + (collapse_name) + '">' +
                    (leg_address) +
                  '</a>' +
                '</h4>' +
              '</div>' +
              '<div id="' + (new_collapse_name) + '">' +
                  '<div class="panel-body">' +
                  '<ul id="' + (step_id) + '">' +
                  '</ul>' +
                '</div>' +
              '</div>';


            var stepsLength = response.routes[0].legs[i].steps.length;
            for (var j = 0; j < stepsLength; j++) {
              var new_collapse_name = 'collapse-' + (i + 1)
              var step_id = "step-" + (i+ 1)
              var steps = document.getElementById(step_id)
              var step_1 = document.getElementById('step-1')
              var instructions = response.routes[0].legs[i].steps[j].instructions;
              var stepLength = response.routes[0].legs[i].steps[j].distance.text;
              if(i === 0){
                step_1.innerHTML = step_1.innerHTML +
                  '<li>' + (instructions) + '</li>' + ' ' +
                  '<p id= "tiny">' + (stepLength) + '</p>';
              }else{
                steps.innerHTML = steps.innerHTML +
                  '<li>' + (instructions) + '</li>' + ' ' +
                  '<p id= "tiny">' + (stepLength) + '</p>';
              }
              document.getElementById(new_collapse_name).className += 'panel-collapse collapse';
            }
          }
          directionsDisplay.setDirections(response);
        }
      });
    }
    calcRoute();

    handler = Gmaps.build('Google');
    handler.buildMap({
        provider: {
          zoom: 8,
          center: new google.maps.LatLng(<%= @walk.start_location.latitude %>, <%= @walk.start_location.longitude %>),
          styles: mapStyle
        },
        internal: {
          id: 'directions'
        }
      },
      function(){
        directionsDisplay.setMap(handler.getMap());
      }
    );
  });
</script>
